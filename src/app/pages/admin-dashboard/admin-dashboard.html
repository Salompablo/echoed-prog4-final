<section class="admin-container">
    <div class="header-section">
        <h2 class="dashboard-title">User Administration Dashboard</h2>
        <p class="subtitle">Manage user accounts, view details, and control access.</p>
    </div>

    @if (isLoading()) {
    <app-loading-spinner message="Loading user data..."></app-loading-spinner>
    } @else if (users().length === 0 && searchQuery() === '') {
    <div class="empty-state-card">
        <p>No users found in the database.</p>
    </div>
    } @else {
    <div class="controls-bar">
        <div class="search-wrapper">
            <span class="material-symbols-rounded search-icon">search</span>
            <input type="text" [ngModel]="searchQuery()" (ngModelChange)="onSearchQueryChange($event)"
                placeholder="Search by Username or Email..." class="search-input" />
        </div>

        <div class="pagination-info">
            Showing users {{ currentPage() * pageSize() + 1 }} - {{ (currentPage() * pageSize() + users().length) }} of
            {{ totalElements() }}
        </div>
    </div>

    <div class="table-responsive-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th class="sortable-header" (click)="onSort('id')">
                        ID
                        <span class="material-symbols-rounded sort-icon">{{ getSortIcon('id') }}</span>
                    </th>

                    <th class="sortable-header" (click)="onSort('username')">
                        Username
                        <span class="material-symbols-rounded sort-icon">{{ getSortIcon('username') }}</span>
                    </th>

                    <th class="sortable-header" (click)="onSort('email')">
                        Email
                        <span class="material-symbols-rounded sort-icon">{{ getSortIcon('email') }}</span>
                    </th>

                    <th>Roles</th>

                    <th class="sortable-header" (click)="onSort('active')">
                        Status
                        <span class="material-symbols-rounded sort-icon">{{ getSortIcon('active') }}</span>
                    </th>

                    <th class="sortable-header" (click)="onSort('createdAt')">
                        Joined Date
                        <span class="material-symbols-rounded sort-icon">{{ getSortIcon('createdAt') }}</span>
                    </th>

                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (user of users(); track user.id) {
                <tr [class.banned-row]="user.isBanned">
                    <td>{{ user.id }}</td>
                    <td>
                        <a [routerLink]="['/profile', user.id]" class="user-link">@{{ user.username }}</a>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <div class="role-pills">
                            @for (role of user.roles; track role) {
                            <span class="role-pill role-{{ role | lowercase }}">{{ role.replace('ROLE_', '') }}</span>
                            }
                        </div>
                    </td>
                    <td>
                        <span class="status-indicator" [class.status-banned]="user.isBanned"
                            [class.status-active]="user.active && !user.isBanned"
                            [class.status-deactivated]="!user.active && !user.isBanned">

                            @if (user.isBanned) {
                            Banned
                            } @else if (user.active) {
                            Active
                            } @else {
                            Deactivated
                            }
                        </span>
                    </td>
                    <td>{{ user.joinDate | date:'shortDate' }}</td>
                    <td>
                        @if (user.isBanned) {
                        <button class="action-btn unban-btn" (click)="onUnbanUser(user.id)"
                            [disabled]="isActionLoading(user.id)">
                            @if (isActionLoading(user.id)) {
                            <span>Unbanning...</span>
                            } @else {
                            <span>Unban</span>
                            }
                        </button>
                        } @else {
                        <button class="action-btn ban-btn" (click)="onBanUser(user.id)"
                            [disabled]="isActionLoading(user.id)">
                            @if (isActionLoading(user.id)) {
                            <span>Banning...</span>
                            } @else {
                            <span>Ban</span>
                            }
                        </button>
                        }
                    </td>
                </tr>
                } @empty {
                <tr>
                    <td colspan="7" class="no-results-row">
                        No users found matching "{{ searchQuery() }}".
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination-footer">
        <button class="page-btn" (click)="onPageChange(currentPage() - 1)"
            [disabled]="currentPage() === 0 || isLoading()">
            &lt; Previous
        </button>

        @for (page of pagesArray(); track page) {
        <button class="page-btn page-number-btn" [class.active]="page === currentPage()" (click)="onPageChange(page)"
            [disabled]="isLoading()">
            {{ page + 1 }}
        </button>
        }

        <button class="page-btn" (click)="onPageChange(currentPage() + 1)"
            [disabled]="currentPage() === totalPages() - 1 || isLoading() || totalPages() === 0">
            Next &gt;
        </button>
    </div>
    }
</section>