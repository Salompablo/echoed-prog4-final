<div class="profile-container">
  @if (loading()) {
  <app-loading-spinner message="Loading profile..."></app-loading-spinner>
  } @else if (error() && !loading()) {
  <div class="error-state error-api">
    <span class="material-symbols-rounded error-icon">error</span>
    <p>{{ error() }}</p>
    <button (click)="refreshProfile()" class="retry-btn">Try Again</button>
  </div>
  } @else if (userProfile(); as profile) {
  <div class="profile-content">
    <div class="profile-header">
      <div class="profile-avatar" [class.is-editing]="isEditMode()">
        <img
          [src]="avatarUrl()"
          [alt]="userProfile()?.username + ' profile avatar'"
          class="profile-picture avatar-image"
          [class.is-editing]="isEditMode()"
        />

        @if (isEditMode()) {
        <button class="avatar-edit-overlay" (click)="openAvatarModal()" aria-label="Change avatar">
          <span class="material-symbols-rounded avatar-edit-icon">edit</span>
        </button>
        }
      </div>
      <div class="profile-details">
        @if (!isEditMode()) {
        <div class="profile-view">
          <h1 class="username">@ {{ profile.username }}</h1>
          @if (isCurrentUserProfile()) {
          <p class="email">{{ authService.currentUser()?.email }}</p>
          } @if (profile.roles.length) {
          <div class="roles">
            <span class="material-symbols-rounded role-icon">workspace_premium</span>
            <span class="roles-text">{{ rolesText() }}</span>
          </div>
          }

          <div class="account-type">
            <span class="material-symbols-rounded provider-icon">link</span>
            <span>{{ accountTypeText() }}</span>
          </div>

          @if (profile.joinDate) {
          <div class="join-date">
            <span class="material-symbols-rounded date-icon">calendar_today</span>
            <span>Joined {{ formattedJoinDate() }}</span>
          </div>
          } @if (profile.biography) {
          <div class="biography">
            <span class="material-symbols-rounded bio-icon">description</span>
            <p class="bio-text">{{ profile.biography }}</p>
          </div>
          } @if (isCurrentUserProfile()) {
          <button (click)="toggleEditMode()" class="edit-btn">
            <span class="material-symbols-rounded">edit</span> Edit Profile
          </button>
          }
        </div>
        } @else {
        <div class="profile-edit">
          <form #profileEditForm="ngForm">
            <div class="form-group">
              <label for="username">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                class="form-input"
                required
                minlength="3"
                maxlength="50"
                placeholder="Your username"
                [ngModel]="profileForm().username"
                (ngModelChange)="updateUsername($event)"
                #usernameInput="ngModel"
              />
              @if (usernameInput.invalid && (usernameInput.dirty || usernameInput.touched)) {
              <div class="error-validation">
                @if (usernameInput.errors?.['required']) {
                <small>Username is required.</small>
                } @if (usernameInput.errors?.['minlength']) {
                <small>Must be at least 3 characters.</small> } @if
                (usernameInput.errors?.['maxlength']) {
                <small>Must not exceed 50 characters.</small> }
              </div>
              }
            </div>
            <div class="form-group">
              <label for="biography">Biography</label>
              <textarea
                id="biography"
                name="biography"
                class="form-textarea"
                rows="3"
                maxlength="500"
                placeholder="Tell us about yourself..."
                [ngModel]="profileForm().biography"
                (ngModelChange)="updateBiography($event)"
              ></textarea>
            </div>

            @if (!isGoogleAccount()){
            <div class="change-password-link">
              <button type="button" class="button-as-link" (click)="openChangePasswordModal()">
                <span class="material-symbols-rounded">lock</span>
                Change Password
              </button>
            </div>
            }

            <div class="form-actions">
              <button
                type="button"
                (click)="saveProfile()"
                [disabled]="saving() || profileEditForm.invalid || !hasUnsavedChanges()"
                class="save-btn"
              >
                @if (!saving()) {
                <span class="material-symbols-rounded">save</span> Save Changes } @if (saving()) {
                <span>Saving...</span> }
              </button>
              <button
                type="button"
                (click)="toggleEditMode()"
                [disabled]="saving()"
                class="cancel-btn"
              >
                <span class="material-symbols-rounded">cancel</span> Cancel
              </button>
            </div>

            @if (hasUnsavedChanges()) {
            <div class="unsaved-warning">
              <span class="material-symbols-rounded">warning</span> You have unsaved changes
            </div>
            }
          </form>
        </div>
        }
      </div>
    </div>

    <div class="profile-stats">
      <h2 class="stats-title">Statistics</h2>
      @if (profile.userStats; as stats) {
      <div class="stats-grid">
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">bar_chart</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.totalReviews ?? 0 }}</span>
            <span class="stat-label">Total Reviews</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">music_note</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.totalSongReviews ?? 0 }}</span>
            <span class="stat-label">Song Reviews</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">album</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.totalAlbumReviews ?? 0 }}</span>
            <span class="stat-label">Album Reviews</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">star_rate</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.averageRating | number : '1.1-1' }}</span>
            <span class="stat-label">Avg Rating</span>
          </div>
        </div>

        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">chat_bubble</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.totalComments ?? 0 }}</span>
            <span class="stat-label">Total Comments</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">audiotrack</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.songComments ?? 0 }}</span>
            <span class="stat-label">Song Comments</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">library_music</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.albumComments ?? 0 }}</span>
            <span class="stat-label">Album Comments</span>
          </div>
        </div>

        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">multiple_stop</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.totalReactions ?? 0 }}</span>
            <span class="stat-label">Total Reacts Given</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">thumb_up</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.likesGiven ?? 0 }}</span>
            <span class="stat-label">Likes Given</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">favorite</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.lovesGiven ?? 0 }}</span>
            <span class="stat-label">Loves Given</span>
          </div>
        </div>
        @if (showAllStats()) {
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">sentiment_satisfied</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.wowsGiven ?? 0 }}</span>
            <span class="stat-label">Wows Given</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">thumb_down</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.dislikesGiven ?? 0 }}</span>
            <span class="stat-label">Dislikes Given</span>
          </div>
        </div>

        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">recommend</span>
          <div class="stat-info">
            <span class="stat-number">{{
              (stats.likesReceived ?? 0) + (stats.lovesReceived ?? 0) + (stats.wowsReceived ?? 0)
            }}</span>
            <span class="stat-label">Positive Recvd</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">gpp_bad</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.dislikesReceived ?? 0 }}</span>
            <span class="stat-label">Negative Recvd</span>
          </div>
        </div>

        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">calendar_month</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.reviewsThisMonth ?? 0 }}</span>
            <span class="stat-label">Reviews (Month)</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">graphic_eq</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.commentsThisMonth ?? 0 }}</span>
            <span class="stat-label">Comments (Month)</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="material-symbols-rounded stat-icon">bolt</span>
          <div class="stat-info">
            <span class="stat-number">{{ stats.reactionsThisMonth ?? 0 }}</span>
            <span class="stat-label">Reacts (Month)</span>
          </div>
        </div>
        }
      </div>

      <div class="stats-toggle-section">
        <button (click)="toggleShowAllStats()" class="button-as-link">
          @if (showAllStats()) {
          <span class="material-symbols-rounded">unfold_less</span>
          <span class="button-link-text">Show Less</span>
          } @else {
          <span class="material-symbols-rounded">unfold_more</span>
          <span class="button-link-text">Show More</span>
          }
        </button>
      </div>
      } @else {
      <div class="stats-loading">Statistics not available.</div>
      }
    </div>
    <div class="profile-reviews">
      <div class="reviews-header">
        @if (isCurrentUserProfile()) {
        <h2 class="reviews-title">My Reviews</h2>
        }@else {
        <h2 class="reviews-title">{{ userProfile()?.username }}' reviews</h2>
        }

        <div class="reviews-tabs">
          <button
            (click)="changeTab('reviews')"
            [class.active]="activeTab() === 'reviews'"
            class="tab-btn"
          >
            All Reviews
          </button>
          <button
            (click)="changeTab('song-reviews')"
            [class.active]="activeTab() === 'song-reviews'"
            class="tab-btn"
          >
            Songs ({{ profile.userStats?.totalSongReviews ?? 0 }})
          </button>
          <button
            (click)="changeTab('album-reviews')"
            [class.active]="activeTab() === 'album-reviews'"
            class="tab-btn"
          >
            Albums ({{ profile.userStats?.totalAlbumReviews ?? 0 }})
          </button>
        </div>
      </div>
      <div class="reviews-content">
        @switch (activeTab()) { @case ('reviews') {
        <app-review-list
          [reviews]="allReviews()"
          [loading]="reviewsLoading() && songReviews().length === 0 && albumReviews().length === 0"
          [showUsername]="false"
          [showMusicInfo]="true"
          emptyMessage="No reviews yet. Start reviewing your favorite music!"
        />
        @if (hasMoreSongReviews() || hasMoreAlbumReviews()) {
        <div class="load-more-section">
          @if (hasMoreSongReviews()) {
          <button
            (click)="loadMoreSongReviews()"
            class="load-more-btn"
            [disabled]="reviewsLoading()"
          >
            @if(reviewsLoading()) {
            <span>Loading...</span>
            } @else {
            <span>Load More Songs</span>
            }
          </button>
          } @if (hasMoreAlbumReviews()) {
          <button
            (click)="loadMoreAlbumReviews()"
            class="load-more-btn"
            [disabled]="reviewsLoading()"
          >
            @if(reviewsLoading()) {
            <span>Loading...</span>
            } @else {
            <span>Load More Albums</span>
            }
          </button>
          }
        </div>
        } } @case ('song-reviews') {
        <app-review-list
          [reviews]="songReviews()"
          [loading]="reviewsLoading() && songReviews().length === 0"
          [showUsername]="false"
          [showMusicInfo]="true"
          emptyMessage="No song reviews yet"
        />
        @if (hasMoreSongReviews()) {
        <button (click)="loadMoreSongReviews()" class="load-more-btn" [disabled]="reviewsLoading()">
          @if(reviewsLoading()) {
          <span>Loading...</span>
          } @else {
          <span>Load More Songs</span>
          }
        </button>
        } } @case ('album-reviews') {
        <app-review-list
          [reviews]="albumReviews()"
          [loading]="reviewsLoading() && albumReviews().length === 0"
          [showUsername]="false"
          [showMusicInfo]="true"
          emptyMessage="No album reviews yet"
        />
        @if (hasMoreAlbumReviews()) {
        <button
          (click)="loadMoreAlbumReviews()"
          class="load-more-btn"
          [disabled]="reviewsLoading()"
        >
          @if(reviewsLoading()) {
          <span>Loading...</span>
          } @else {
          <span>Load More Albums</span>
          }
        </button>
        } } }
      </div>
    </div>
    @if (isCurrentUserProfile()) {
    <div class="danger-zone card">
      <h4>Danger Zone</h4>
      <p>
        Deactivating your account will hide your profile and all of your content. You can reactivate
        your account by logging in again.
      </p>
      <button (click)="openDeactivateModal()" class="button danger-btn">
        Deactivate My Account
      </button>
    </div>
    }
  </div>
  } @else {
  <p>User profile could not be loaded.</p>
  }
</div>

@if(isChangePasswordModalVisible()){
<app-change-password-modal (close)="closeChangePasswordModal()"></app-change-password-modal>
} @if (isDeactivateModalVisible()) {
<app-deactivate-account-modal
  [isGoogleAccount]="isGoogleAccount()"
  (close)="closeDeactivateModal()"
></app-deactivate-account-modal>
} @if (isAvatarModalVisible()) {
<app-avatar-picker-modal
  (close)="closeAvatarModal()"
  (avatarSelected)="onAvatarSelected($event)"
></app-avatar-picker-modal>
}
